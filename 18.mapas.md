```
Programa de Ingenier√≠a de Sistemas y Computaci√≥n
Universidad del Quind√≠o

T√≠tulo: Mapas con Mapbox en Angular
Duraci√≥n estimada: 120
Docentes: Carlos Andr√©s Florez
Gu√≠a: 18
```

# Mapas con Mapbox en Angular

## üéØ Objetivo 

Implementar Mapbox en el proyecto final para aquellas p√°ginas donde sea necesario mostrar reportes o crearlos por medio de mapas.

---

## Conceptos b√°sicos

- **HTML**: Lenguaje de etiquetas de hipertexto usado para estructurar p√°ginas web.
- **Framework CSS**: Conjunto de herramientas y convenciones predefinidas que facilitan el desarrollo de interfaces web estilizadas, por ejemplo: Bootstrap.
- **Lenguaje de programaci√≥n TypeScript**: Superset de JavaScript que a√±ade tipado est√°tico y otras caracter√≠sticas.
- **Componentes en Angular**: Bloques reutilizables de c√≥digo que encapsulan la l√≥gica, la plantilla HTML y los estilos CSS para crear partes independientes de una aplicaci√≥n web.
- **Servicios en Angular**: Clases que proporcionan funcionalidades compartidas y reutilizables, como la gesti√≥n de datos o la comunicaci√≥n con APIs.
- **Inyecci√≥n de dependencias en Angular**: Patr√≥n de dise√±o que permite a los componentes y servicios recibir sus dependencias de manera autom√°tica, facilitando la modularidad.

---

## Contextualizaci√≥n Te√≥rica

### ¬øQu√© es Mapbox?

[Mapbox](https://www.mapbox.com/) es un proveedor de mapas avanzado que ofrece una **API muy completa** para integrar funcionalidades de navegaci√≥n en proyectos **web (JavaScript)** o **m√≥viles (Kotlin, Swift)**.

Los datos de Mapbox provienen de diversas fuentes abiertas, entre ellas **OpenStreetMap** y la **NASA**, lo que garantiza informaci√≥n geogr√°fica actualizada y de alta calidad.

Se puede consultar la documentaci√≥n oficial en: [https://docs.mapbox.com/mapbox-gl-js/guides/](https://docs.mapbox.com/mapbox-gl-js/guides/)

### Prop√≥sito en el Proyecto

Mapbox se utilizar√° en nuestro proyecto con dos objetivos principales:

1. **Mostrar marcadores** en el mapa con los alojamientos existentes en la p√°gina de inicio.
2. **Seleccionar la ubicaci√≥n** de un nuevo alojamiento en el formulario de creaci√≥n, permitiendo obtener autom√°ticamente su latitud y longitud.

### Marcadores (Markers)

Para ambos casos se emplear√°n [markers](https://docs.mapbox.com/help/getting-started/add-markers/), los cuales son iconos que pueden ubicarse en cualquier punto del mapa.
Estos marcadores son totalmente personalizables ‚Äîpueden cambiar de color, tama√±o, forma o incluso incluir contenido HTML o im√°genes‚Äî, lo que permite representar visualmente distintos tipos de alojamientos o estados.

### Creaci√≥n de un Mapa

Para usar Mapbox es necesario **generar un token de acceso**. Este se obtiene desde [https://account.mapbox.com/](https://account.mapbox.com/) (requiere crear una cuenta gratuita con el correo institucional).

Una vez se cuenta con el token, se puede crear un objeto de tipo `Map`, que requiere las siguientes propiedades principales:

* **container:** id del `div` que contendr√° el mapa en el HTML.
* **style:** estilo visual del mapa (Mapbox ofrece una gran variedad de estilos predise√±ados).
* **center:** coordenadas donde se centrar√° el mapa al cargar.
* **zoom:** nivel de acercamiento inicial.

Un mapa b√°sico en Mapbox se ver√≠a de la siguiente forma:

![Mapa de Mapbox](media/mapa.png)

### Funcionalidades Avanzadas

Adem√°s de los marcadores, Mapbox ofrece m√∫ltiples herramientas para enriquecer la experiencia de navegaci√≥n, entre ellas:

* **Visualizaci√≥n 3D:** permite mostrar edificios y terrenos en tres dimensiones, generando una experiencia m√°s inmersiva.
* **Rutas y navegaci√≥n:** trazado de rutas entre puntos, c√°lculo de distancias y tiempos estimados de viaje.
* **Informaci√≥n en tiempo real:** estado del tr√°fico, condiciones del terreno y visualizaci√≥n din√°mica de datos geoespaciales.

De hecho, empresas como **BMW**, **Strava**, **Snapchat** o **KFC** utilizan Mapbox para potenciar sus sistemas de navegaci√≥n y an√°lisis geogr√°fico.

---

## Precauciones y Recomendaciones

Verifique que tiene instalado NodeJS en su √∫ltima versi√≥n para poder compilar y ejecutar la aplicaci√≥n de Angular. Tenga en cuenta que el proyecto del backend no es necesario para esta gu√≠a, por lo que no es necesario tenerlo corriendo.

---

## Evaluaci√≥n o Resultado

Se espera que el estudiante logre comprender c√≥mo implementar Mapbox en un proyecto web, como por ejemplo: poner marcadores, arrastrarlos en el mapa y programar diferentes eventos.

---

## Procedimiento

### 1. Instalaci√≥n de dependencias de Mapbox

Para hacer uso de todas las funcionalidades explicadas anteriormente, es necesario agregar a nuestro proyecto de angular dos dependencias.

Escriba lo siguiente en el cmd de Windows o la terminal de GNU/Linux o Mac (se debe ejecutar en la carpeta ra√≠z del proyecto de Angular).

```bash
pnpm install mapbox-gl
```

```bash
pnpm install @types/mapbox-gl
```

### 2. Configuraci√≥n de estilos en angular.json

Luego, nos dirigimos al archivo `angular.json` y agregamos la ruta del archivo de estilos de mapbox necesario para su correcto funcionamiento.

En la lista `styles` (la misma que usamos para bootstrap) agregue: `"node_modules/mapbox-gl/dist/mapbox-gl.css"`

### 3. Creaci√≥n del servicio de mapa

Centralizar las funcionalidades del mapa en un servicio es una buena pr√°ctica ya que es m√°s f√°cil agregar, modificar o configurar aspectos relacionados a Mapbox. Si m√°s adelante necesitamos funcionalidades adicionales se pueden agregar en dicho servicio.

Escriba lo siguiente en el cmd de Windows o en la terminal de GNU/Linux o Mac (recuerde ejecutar esto en la carpeta **services** del proyecto de Angular):

```bash
ng generate service map-service --skip-tests
```

### 4. Implementaci√≥n del servicio de mapa

Modifique la clase `MapService` para que quede as√≠:

```typescript
import { Injectable, OnDestroy } from '@angular/core';
import { Observable, Subject } from 'rxjs';
import mapboxgl, { LngLatLike, Map, Marker, MapMouseEvent } from 'mapbox-gl';
import { MarkerDTO } from '../models/marker-dto';

@Injectable({
  providedIn: 'root',
})
export class MapService implements OnDestroy {

  private map?: Map;
  private markers: Marker[] = [];
  private currentLocation: LngLatLike = [-75.6727, 4.53252];
  private readonly MAPBOX_TOKEN = 'COPIAR ACCESS TOKEN AQU√ç';
  private destroy$ = new Subject<void>();

  constructor() {
    mapboxgl.accessToken = this.MAPBOX_TOKEN;
  }

  /** Inicializa el mapa dentro del contenedor especificado */
  public create(containerId: string = 'map'): void {
    if (this.map) {
      this.map.remove(); // Evita fugas si se recrea el mapa
    }

    this.map = new mapboxgl.Map({
      container: containerId,
      style: 'mapbox://styles/mapbox/standard',
      center: this.currentLocation,
      zoom: 17,
      pitch: 45,
    });

    this.map.addControl(new mapboxgl.NavigationControl());
    this.map.addControl(
      new mapboxgl.GeolocateControl({
        positionOptions: { enableHighAccuracy: true },
        trackUserLocation: true,
      })
    );
  }

  /** Dibuja varios marcadores con popup */
  public drawMarkers(places: MarkerDTO[]): void {
    if (!this.map) return;

    places.forEach(({ id, title, photoUrl, location }) => {
      const popupHtml = `
        <strong>${title}</strong>
        <div>
          <img src="${photoUrl}" alt="Imagen" style="width: 100px; height: 100px;">
        </div>
        <a href="/place/${id}">Ver m√°s</a>
      `;

      new mapboxgl.Marker({ color: 'red' })
        .setLngLat([location.longitude, location.latitude])
        .setPopup(new mapboxgl.Popup().setHTML(popupHtml))
        .addTo(this.map!);
    });
  }

  /** Devuelve el mapa actual (si existe) */
  public get mapInstance(): Map | undefined {
    return this.map;
  }

  /** Limpieza al destruir el servicio */
  ngOnDestroy(): void {
    this.destroy$.next();
    this.destroy$.complete();

    if (this.map) {
      this.map.remove();
      this.map = undefined;
    }
  }
}
```

A continuaci√≥n una explicaci√≥n de cada funci√≥n del servicio:

**`constructor`:**

- Se inicializa el token de acceso de Mapbox GL con una clave proporcionada por el usuario. Este token es necesario para acceder a los servicios de Mapbox. **Debe crear una cuenta en [https://account.mapbox.com/auth/signup](https://account.mapbox.com/auth/signup) para generar el Access Token. Aseg√∫rese de que al momento de crear la cuenta use su correo electr√≥nico institucional.**

**`create()`:**

- Esta funci√≥n crea un mapa de Mapbox GL dentro de un contenedor HTML especificado por su id (por defecto es 'mapa').
- Si ya existe un mapa, se elimina para evitar fugas de memoria.
- Se configura el mapa con un estilo predeterminado, una ubicaci√≥n central y un nivel de zoom inicial.
- Se agregan controles de navegaci√≥n y geolocalizaci√≥n al mapa.

**`drawMarkers()`:**

- Esta funci√≥n recibe una lista de objetos `MarkerDTO` que contienen informaci√≥n sobre la ubicaci√≥n y detalles de cada marcador.
- Para cada marcador en la lista, se crea un marcador en el mapa con la posici√≥n correspondiente y se le asigna un cuadro emergente (popup) con informaci√≥n adicional, incluyendo una imagen y un enlace.
- Esta funci√≥n es √∫til para mostrar m√∫ltiples marcadores en el mapa, como los alojamientos en la p√°gina de inicio.
- Se asegura de que el mapa est√© inicializado antes de intentar agregar los marcadores.

**`mapInstance()`:**

- Esta es una propiedad de solo lectura que devuelve la instancia actual del mapa si est√° disponible. 
- Puede ser √∫til para acceder directamente al objeto del mapa para realizar operaciones adicionales.

**`ngOnDestroy()`:**

- Esta funci√≥n se llama cuando el servicio es destruido.
- Se emite un evento para limpiar cualquier suscripci√≥n activa y se completa el sujeto `destroy$`.
- Si el mapa existe, se elimina y se establece en `undefined` para liberar recursos.

### 5. Creaci√≥n del modelo `MarkerDTO`

Dado que la funci√≥n `drawMarkers()` recibe una lista de `MarkerDTO`, es necesario crear este modelo. Cree el archivo `marker-dto.ts` en la carpeta **models** y agregue lo siguiente:

```typescript
import { LocationDTO } from "./place-dto";

export interface MarkerDTO {
    id: number,
    location: LocationDTO,
    title: string,
    photoUrl: string
}
```

Este DTO representa la informaci√≥n necesaria para mostrar un marcador en el mapa, incluyendo su ubicaci√≥n, t√≠tulo e imagen. Se asume que `LocationDTO` ya est√° definido en `place-dto.ts`.

### 6. Personalizaci√≥n del popup del marcador

Ajuste el popup del marcador para que tenga un dise√±o m√°s interesante, haga que se muestre la imagen destacada del alojamiento, su t√≠tulo, direcci√≥n y calificaciones promedio.

Para conocer m√°s sobre Popups: [https://docs.mapbox.com/mapbox-gl-js/example/popup-on-click/](https://docs.mapbox.com/mapbox-gl-js/example/popup-on-click/)

### 7. Estructura HTML para el mapa en inicio

Modifique el componente `Home`, exactamente el archivo `home.html` para agregar el mapa, as√≠:

```html
<div id="map"></div>
```

### 8. Estilos CSS para el mapa en inicio

Modifique el archivo `home.css` para agregar las dimensiones del mapa, as√≠:

```css
#map {
    width: 100vw;
    height: 100vh;
}
```

Esto har√° que el mapa ocupe toda la pantalla. Si desea que el mapa ocupe solo una parte de la pantalla, puede ajustar los valores de `width` y `height` seg√∫n sus necesidades.

### 9. Configuraci√≥n del componente de inicio

Modifique el componente `Home` para que quede as√≠:

```typescript
import { Component, OnInit } from '@angular/core';
import { MapService } from '../../services/map-service';

@Component({
  selector: 'app-home',
  imports: [RouterModule],
  templateUrl: './home.html',
  styleUrl: './home.css'
})
export class Home implements OnInit {

  // Se inyecta el servicio de mapa en el constructor del componente
  constructor(private mapService: MapService) { }

  ngOnInit(): void {
    this.mapService.create();
  }
}
```

El componente `Home` utiliza el servicio `MapService` en su m√©todo `ngOnInit()` para inicializar el mapa cuando el componente se carga. `OnInit` es un ciclo de vida del componente que **se ejecuta despu√©s** de que Angular ha inicializado todas las propiedades vinculadas a datos del componente. 

Inicializar el mapa en `ngOnInit()` **asegura** que el mapa se configure correctamente una vez que el componente est√© listo para interactuar con el DOM.

### 10. Verificaci√≥n del mapa en inicio

Ejecute el proyecto y pruebe que el mapa s√≠ se muestra en la p√°gina de inicio. Active la geolocalizaci√≥n para que el mapa se centre en su ubicaci√≥n actual.

### 11. Mostrar alojamientos en el mapa de inicio

Haga que en el mapa de la p√°gina de inicio se muestren los alojamientos haciendo uso de marcadores. Para esto, por ahora podemos hacer uso del servicio `PlacesService` que tiene unos alojamientos de prueba. Modifique la funci√≥n `ngOnInit()` del componente `Home` para que quede as√≠:

```typescript
ngOnInit(): void {
  this.mapService.create();

  const places = this.placesService.getAll();
  this.mapService.drawMarkers(places); // Es necesario que haga un map de places a MarkerDTO
}
```

En este caso, `placesService.getAll()` devuelve una lista de alojamientos de prueba. Posteriormente, se llama a `mapService.drawMarkers(places)` para agregar los marcadores correspondientes en el mapa.

Para que esto funcione, debe inyectar `PlacesService` en el constructor del componente `Home`, as√≠:

```typescript
constructor(private placesService: PlacesService) { }
```

Recuerde hacer el `import` correspondiente y no borre la inyecci√≥n de `MapService` que se hizo anteriormente.

### 12. Verificaci√≥n del mapa en inicio

Ejecute el proyecto y verifique que los alojamientos de prueba se muestran correctamente en el mapa de la p√°gina de inicio.

### 13. Integraci√≥n del mapa en el formulario de crear alojamiento

Para crear un nuevo alojamiento es necesario conocer su latitud y longitud. Dado que obtener estos valores manualmente resulta poco pr√°ctico, utilizaremos un mapa interactivo que nos permitir√° seleccionarlos de forma visual y precisa. 

Modifique el archivo `create-place.html` para agregar el mapa en el formulario, si previamente ya tiene un campo para la ubicaci√≥n, puede eliminarlo. Agregue lo siguiente en el formulario:

```html
<div class="col-12">
  <label class="form-label">Ubicaci√≥n: </label>
  <div id="map"></div>
</div>
```

Recuerde agregar las dimensiones del mapa en el archivo crear-reporte.component.css.

```css
#map {
    width: 100%;
    height: 300px;
}
```

### 14. Implementaci√≥n de `ngOnInit` en `CreatePlace`

Haga que la clase `CreatePlace` implemente `OnInit` y en la funci√≥n `ngOnInit()` agregue lo siguiente:

```typescript
ngOnInit(): void {
  // Inicializa el mapa con la configuraci√≥n predeterminada
  this.mapService.create();

  // Se suscribe al evento de agregar marcador y actualiza el formulario
  this.mapService.addMarker().subscribe((marker) => {
    this.createPlaceForm.get('location')?.setValue({
      latitude: marker.lat,
      longitude: marker.lng,
    });
  });
}
```

La funci√≥n `ngOnInit()` inicializa el mapa y agrega un marcador en respuesta a un clic. Posteriormente, actualiza las coordenadas de la ubicaci√≥n del alojamiento en el formulario.

Para que esto funcione correctamente, debe inyectar `MapService` en el constructor de la clase, como se hizo en el componente `Home`.

### 15. Agregar la funci√≥n `addMarker` en `MapService`

Agregue la siguiente funci√≥n en la clase `MapService`:

```typescript
public addMarker(): Observable<mapboxgl.LngLat> {
  return new Observable((observer) => {
    if (!this.map) {
      observer.error('Mapa no inicializado');
      return;
    }

    // Limpia los marcadores existentes y agrega uno nuevo en la posici√≥n del click
    const onClick = (e: MapMouseEvent) => {
      this.clearMarkers();
      const marker = new mapboxgl.Marker({ color: 'red' })
        .setLngLat(e.lngLat)
        .addTo(this.map!);

      this.markers.push(marker);
      // Emite las coordenadas del marcador al observador
      observer.next(marker.getLngLat());
    };

    this.map.on('click', onClick);

    // Limpieza al desuscribirse
    return () => {
      this.map?.off('click', onClick);
    };
  });
}
```

Esta funci√≥n crea un observable que emite las coordenadas del marcador cada vez que el usuario hace clic en el mapa. Si el mapa no est√° inicializado, se emite un error. Adem√°s, se asegura de limpiar los eventos al desuscribirse.

### 16. Verificaci√≥n del mapa en el formulario

Ejecute el proyecto y pruebe que el mapa se muestra en el formulario. Haga click en el mapa y observe que el marcador se agrega y que las coordenadas son capturadas correctamente. 

Imprima los valores del formulario en la consola para verificar que las coordenadas se est√°n asignando correctamente.

### 17. Control de versiones

Recuerde guardar todos los cambios en GIT y en GitHub.

---

## Para la pr√≥xima clase

- Investigue acerca de `HttpClient` de Angular.
- Investigue sobre Guards e Interceptors de Angular y para qu√© se usan.