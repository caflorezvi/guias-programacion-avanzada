```
Programa de Ingenier칤a de Sistemas y Computaci칩n
Universidad del Quind칤o

T칤tulo: Despliegue en la nube
Duraci칩n estimada: 60
Docentes: Carlos Andr칠s Florez
Gu칤a: 21
```

# Despliegue en la nube

## 游꿢 Objetivo 

Desplegar una aplicaci칩n web completa (backend y frontend) en la nube usando servicios PaaS (Platform as a Service) como Railway y Firebase.

---

## Conceptos b치sicos

- **Contenedores:** Entornos ligeros y port치tiles que encapsulan una aplicaci칩n y sus dependencias.
- **Docker:** Plataforma que permite crear, desplegar y ejecutar aplicaciones en contenedores.
- **GIT:** Sistema de control de versiones distribuido para gestionar el c칩digo fuente.
- **Angular:** Framework de desarrollo frontend para construir aplicaciones web din치micas.
- **Spring Boot:** Framework de desarrollo r치pido para aplicaciones Java basadas en Spring.

---

## Contextualizaci칩n Te칩rica

La 칰ltima etapa en el desarrollo de software es el **despliegue de la aplicaci칩n** o del software a producci칩n. Para realizar esto existen diversas tecnolog칤as que van desde lo m치s manual hasta un proceso completamente automatizado. 

Una opci칩n es configurar de manera manual, por nuestros propios medios el servidor, instalar el software necesario, configurar puertos, servicios, protocolos, dominios, bases de datos, etc. y tambi칠n dar mantenimiento al hardware. Esta opci칩n suele ser muy costosa y requiere demasiado trabajo, por lo tanto, hay empresas que se encargan de hacer todo esto y ofrecen su trabajo como servicios (en la nube) a cambio de un precio que se puede pagar mensual, anual, cada tres a침os, etc. 

Este tipo de tecnolog칤a se divide en IaaS (Infrastructure as a service), PaaS (Platform as a Service) y SaaS (Software as a service).

- **SaaS** es simplemente software que utilizamos en el d칤a a d칤a. Este software es mantenido y actualizado por alguna empresa. Nosotros solo somos usuarios finales. Ejemplo: Google maps, aplicaciones de correo electr칩nico, Google Docs, Zoom, entre otros.

- **PaaS** permite desplegar aplicaciones hechas en alg칰n lenguaje de programaci칩n en alguna instancia de un servidor de una empresa. Este servicio solo proporciona una plataforma para desplegar la aplicaci칩n y la base de datos. Lo bueno, es que no tenemos que preocuparnos por montar el compilador, m치quinas virtuales, procesos, sistema operativo, etc. ya que el servicio se encarga de eso. Algunos ejemplos de de PaaS son: [Railway](https://railway.com), [Heroku](https://www.heroku.com/), [Render](https://render.com/), [Vercel](https://vercel.com/), [Fly.io](https://fly.io/), entre otros.

- **IaaS** permite controlar todos los aspectos de software de un servidor: puertos, protocolos, sistemas operativos, compiladores, etc. Este es el servicio m치s completo de todos, ya que no solo se queda en el despliegue de la aplicaci칩n sino en otros aspectos m치s t칠cnicos (de bajo nivel). Ejemplo: AWS, Azure, Google Cloud, Digital Ocean, etc.

En esta gu칤a nos enfocaremos en **PaaS**, ya que es la opci칩n m치s sencilla y econ칩mica para desplegar aplicaciones web, adem치s, es una de las opciones m치s usadas en la industria actualmente.

El servicio PaaS que usaremos es [Railway](https://railway.com) para el backend y [Firebase](https://firebase.google.com/) para el frontend.

---

## Precauciones y Recomendaciones

Tenga cuidado con el manejo de ramas en su repositorio de GitHub. Para estar seguro, ejecute el comando git status dentro de la carpeta del proyecto y le dir치 en que rama est치. Una vez est칠 seguro de la rama de trabajo actual entonces puede hacer add, commit o push tranquilamente.

---

## Evaluaci칩n o Resultado

Se espera que el estudiante aprenda a utilizar la herramienta Railway y Firebase para hacer un despliegue autom치tico de un proyecto (backend y frontend) en la nube. De igual manera, se espera que comprenda la utilidad de las ramas de Git para gestionar el c칩digo de un proyecto adecuadamente.

---

## Despliegue del backend

### 1. Creaci칩n de una nueva rama

Crear una nueva rama en el proyecto de Spring Boot. Para esto simplemente vaya a la carpeta del proyecto y con git escriba:

```bash
git checkout -b railway
```

La idea de crear una nueva rama es no alterar el estado del proyecto, evitando as칤 da침ar la configuraci칩n, conexiones a base de datos y funcionamiento en general en el entorno local. La rama `main` (o `master`) debe seguir estando igual a como estaba antes de esta gu칤a.

Si en cualquier momento desea regresar a la rama `main` (o `master`) ejecute:

```bash
git checkout main
```

### 2. Creaci칩n del `Dockerfile`

Agregue un archivo en la ra칤z del proyecto principal que se llame `Dockerfile`. Y escriba lo siguiente.

```dockerfile
#
# Etapa de construcci칩n
#
FROM gradle:8.7-jdk21 AS build
USER gradle
WORKDIR /home/gradle/project

# Copiar solo archivos necesarios primero para aprovechar el cache de dependencias
COPY --chown=gradle:gradle build.gradle settings.gradle ./
COPY --chown=gradle:gradle gradle gradle
RUN gradle --no-daemon build -x test || return 0

# Copiar el resto del c칩digo fuente
COPY --chown=gradle:gradle . .

# Construir el archivo JAR
RUN gradle --no-daemon bootJar

#
# Etapa de empaquetado
#
FROM eclipse-temurin:21-jre
ENV APP_HOME=/app
WORKDIR ${APP_HOME}

# Argumento opcional para puerto
ARG PORT=8080
ENV PORT=${PORT}

# Copiar el JAR generado desde la etapa de construcci칩n
COPY --from=build /home/gradle/project/build/libs/*.jar app.jar

EXPOSE ${PORT}
ENTRYPOINT ["java", "-jar", "app.jar"]
```

Un Dockerfile es un archivo de texto que contiene instrucciones para construir una imagen de Docker. En este caso, el Dockerfile tiene dos etapas: la primera etapa construye el proyecto usando Gradle y la segunda etapa empaqueta el archivo JAR generado en una imagen de Docker basada en Eclipse Temurin JRE 21.

Usar Docker facilita el despliegue de aplicaciones, ya que encapsula todo lo necesario para ejecutar la aplicaci칩n en un contenedor.

### 3. Creaci칩n del archivo `system.properties`

Agregue un archivo en la ra칤z del proyecto principal que se llame `system.properties`. Y escriba lo siguiente.

```properties
java.runtime.version=21
```

Es necesario indicar qu칠 versi칩n de Java se va a usar para compilar el proyecto, aunque el Dockerfile define esta configuraci칩n, es una buena pr치ctica indicarlo en el archivo de propiedades. Las herramientas de despliegue suelen usar este archivo para elegir el JDK adecuado.


### 4. Configuraci칩n de PostgreSQL

Modifique la parte de la configuraci칩n de la base de datos del archivo `application.properties` del proyecto para que quede as칤:

```properties
# Configuraci칩n datasource
spring.datasource.url=jdbc:postgresql://${PGHOST}:${PGPORT}/${PGDATABASE}?serverTimezone=UTC
spring.datasource.username=${PGUSER}
spring.datasource.password=${PGPASSWORD}
spring.datasource.driver-class-name=org.postgresql.Driver

# Configuraci칩n JPA/Hibernate
spring.jpa.hibernate.ddl-auto=update
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.PostgreSQLDialect
```

Railway tiene compatibilidad con varios sistemas de gesti칩n de bases de datos (SGBD). Uno de ellos es *PostgreSQL*, entonces lo usaremos para almacenar la informaci칩n en la nube. Afortunadamente nuestra aplicaci칩n con Spring Boot usa Hibernate JPA, un framework de persistencia que es independiente al SGBD, por lo tanto **podemos cambiar de MariaDB a PostgreSQL sin ning칰n problema**. Las tablas se generar치n autom치ticamente y las queries seguir치n funcionando gracias a que las escribimos usando JPQL.

En el archivo de propiedades **quitamos todo lo referente a la conexi칩n con MariaDB** y definimos una configuraci칩n para la conexi칩n a la base de datos por medio de variables de entorno que m치s adelante ser치n definidas en la p치gina de configuraci칩n del proyecto de Railway. 

Adem치s, si tiene en el archivo `application.properties` la propiedad `server.port` con un valor diferente a `8080`, **debe eliminarla o cambiarla** a `8080`, ya que Railway expone el puerto 8080 para las aplicaciones web.

> 丘멆잺 **Nota:** Si en su proyecto de Spring Boot tiene una entidad llamada `User` debe agregar la anotaci칩n `@Table(name = "users")` para evitar conflictos con la tabla reservada `user` en PostgreSQL.

### 5. Actualizaci칩n del `build.gradle`

Modifique el `build.gradle` para agregar el driver de PostgreSQL:

```groovy
runtimeOnly 'org.postgresql:postgresql:42.7.8'
```

Adem치s, **borre la dependencia de MariaDB** o de cualquier otro motor de base de datos que est칠 usando. Tambi칠n es recomendable quitar (o comentar) del archivo `build.gradle` lo siguiente:

```gradle
tasks.named('test') {
    useJUnitPlatform()
}
```

Actualice gradle para que realice los cambios pertinentes. Recuerde que esto se logra sincronizando el proyecto en su IDE (IntelliJ, Eclipse, VSCode, etc.).

### 6. Commit y push a GitHub

Haga commit de sus ajustes y luego haga push al repositorio remoto en la rama `railway`. Aseg칰rese de estar en la rama correcta antes de hacer el push.

```bash
git push origin railway
```

### 7. Creaci칩n de cuenta en Railway

Cree una cuenta en la p치gina web de railway [https://railway.com/](https://railway.com/), para esto use su cuenta de GitHub (autorice todo). Railway ofrece un plan gratuito con ciertas limitaciones que son suficientes para desplegar proyectos peque침os.

### 8. Verificaci칩n de cuenta

Es importante que verifique su cuenta para acceder a los servicios gratuitos sin problemas. Para esto debe dar click en el enlace que le env칤an a su correo electr칩nico sino recibi칩 el correo, este enlace tambi칠n aparece en el dashboard de Railway una vez haya iniciado sesi칩n.

### 9. Creaci칩n de base de datos PostgreSQL

En la p치gina principal de Railway vaya a la opci칩n New y elija **Database** y luego seleccione **PostgreSQL**.

De esta manera ya tenemos una base de datos en la nube. La cual tiene sus propios datos de conexi칩n que podemos usar en cualquier proyecto. Al acceder a la base de datos podemos ver las variables de conexi칩n y otras configuraciones.

Esto crea un proyecto en Railway con una base de datos PostgreSQL. Ahora debemos conectar nuestro proyecto de Spring Boot a esta base de datos.

### 10. Conexi칩n con GitHub

Ahora vamos a crear el proyecto de Spring Boot, para esto nos conectaremos al repositorio por medio de GitHub. En la p치gina principal del proyecto vaya a la parte superior derecha y de click en **Create** - **GitHub Repo** y luego autorice el acceso de Railway a su cuenta de GitHub. 

Despu칠s de autorizar el acceso, Railway le mostrar치 una lista de los repositorios que tiene en su cuenta de GitHub, seleccione el proyecto de Spring Boot que desea desplegar.

### 11. Configuraci칩n de variables de entorno

Cuando el proyecto se haya terminado de crear, selecci칩nelo y vaya a la parte de **Variables**, d칠 click en **"New variable"**. Agregue la variable `PORT` con el valor `8080`. Esto le indica a Railway que el contenedor de Docker debe exponer el puerto 8080 para que la aplicaci칩n sea accesible desde internet.

Adem치s, se deben agregar las variables de conexi칩n a la base de datos PostgreSQL que cre칩 anteriormente. Para esto, de click en **"New variable"** nuevamente y despliegue las opciones que salen en `Add Reference` y elija las variables de la base de datos PostgreSQL que cre칩 anteriormente. Debe agregar las siguientes variables:

- `PGHOST`
- `PGPORT`
- `PGDATABASE`
- `PGUSER`
- `PGPASSWORD`

Railway debe asignar autom치ticamente los valores correctos a estas variables.

### 12. Configuraci칩n de despliegue autom치tico

Luego vaya a la opci칩n **Settings** y realice la siguiente configuraci칩n: 

En `Source`:

- `Source Repo` Aseg칰rese que est칠 seleccionado el repositorio correcto.
- `Branch connected to production` Elija la rama `railway`.

En `Build`:

- `Builder` Elija Dockerfile.

Lo dem치s d칠jelo como est치. Luego, en la parte superior izquierda de la pantalla debe salir una peque침a alerta con un bot칩n que dice **Deploy**. De click en ese bot칩n para iniciar el despliegue.

### 13. Verificaci칩n del despliegue

En la parte de **Deployments** podemos ver un hist칩rico de despliegues y el estado actual del 칰ltimo.

Tenga en cuenta que el despliegue puede tardar varios minutos, para observar c칩mo va el despliegue puede acceder a los logs dando click en el bot칩n **View Logs**.

Si todo ha salido correctamente, el proceso finalizar치 con un mensaje similar al siguiente:

```bash
Tomcat initialized with port(s): 8080 (http)
```

Si hay alg칰n error, revise los logs para identificar el problema.

### 14. Crear URL p칰blica del backend

Regrese al men칰 **Settings** del proyecto de Spring Boot y en la secci칩n de **Networking** de click en un bot칩n que dice **Generate Domain**. Esto generar치 una URL p칰blica desde la cual podr치 acceder a su aplicaci칩n backend desde cualquier parte del mundo.

### 15. Prueba del backend

Acceda a dicha ruta y verifique que el servicio funciona correctamente enviando algunas peticiones (por ejemplo, utilizando Postman). Tenga en cuenta que la capa gratuita de Railway presenta **ciertas limitaciones en cuanto al uso de CPU y memoria**; por lo tanto, es posible que la aplicaci칩n tarde un poco m치s en responder o que el servicio se detenga temporalmente si excede los recursos disponibles. 

### 16. Verificaci칩n de tablas en PostgreSQL

Adem치s, si todo ha salido bien, puede ir a la aplicaci칩n de PostgreSQL en Railway y en el men칰 **Database** puede ver las tablas que se han generado desde Spring Boot de manera autom치tica, y si ha registrado datos, tambi칠n podr치 verlos all칤.

---

## Despliegue del frontend

### 1. Creaci칩n de nueva rama

En el proyecto de angular cree una nueva rama con el nombre que desee. Por ejemplo *firebase*:

```bash
git checkout -b firebase
```

### 2. Actualizaci칩n de URLs de servicios

Dado que el proyecto de Spring Boot (backend) ya est치 desplegado en Railway entonces modifique las url de los servicios para que en lugar de apuntar a [http://localhost:8080/](http://localhost:8080/) ahora lo haga a la url de Railway.

Si est치 usando archivos de constantes (`environments`) entonces modifique el archivo `environment` de producci칩n para que apunte a la url de Railway.

### 3. Creaci칩n de proyecto en Firebase

Vaya a [Firebase](https://console.firebase.google.com/) y cree un nuevo proyecto con el nombre de su preferencia. En la siguiente pantalla deshabilite Gemini y Google Analytics y de clic en "Crear Proyecto".

### 4. Instalaci칩n de Firebase Tools

Instale la herramienta de firebase en su computador por medio de npm. Escriba lo siguiente en el cmd de Windows o en la terminal de GNU/Linux o MacOS:

```bash
npm install -g firebase-tools
```

### 5. Login en Firebase

Una vez instalado, escriba ahora lo siguiente para loguearse en *firebase* desde su computador:

```bash
firebase login
```

Se abrir치 una ventana en el navegador para que inicie sesi칩n con su cuenta de Google (la misma que us칩 para crear el proyecto en Firebase).

### 6. Inicializaci칩n de Firebase en el proyecto

Ahora, en la carpeta ra칤z de su proyecto de angular escriba lo siguiente:

```bash
firebase init
```

Al escribir esto aparecer치 un asistente en consola para configurar el proyecto local de angular.

A la primera pregunta elegimos la opci칩n "Hosting: Set up deployments for static web apps".

Luego elegimos "Use an existing project". Y seleccionamos el proyecto creado anteriormente. Finalmente en la parte de Hosting Setup escribimos lo siguiente en cada pregunta:

- **What do you want to use as your public directory?** solo presione Enter (deje el valor por defecto `public`)
- **Configure as a single-page app (rewrite all urls to /index.html)?** Y
- **Set up automatic builds and deploys with GitHub?** n (opcional)

Una vez terminado (cuando nos salga el mensaje "Firebase initialization complete!") aparecer치n dos archivos en el proyecto local, uno llamado `.firebaserc` y otro `firebase.json` que contienen la configuraci칩n con el servidor de Firebase con el proyecto. Tambi칠n se crear치 una carpeta `public` con un `index.html`, este archivo no lo vamos a usar ya que Angular construye su propio `index.html` al compilar la aplicaci칩n. Este archivo se puede borrar.

> 丘멆잺 **Nota:** Si lo desea, puede habilitar la opci칩n "Set up automatic builds and deploys with GitHub". Aunque no es obligatorio, al activarla se realizar치 el despliegue autom치ticamente cada vez que haga push a la rama configurada de Firebase. Investigue c칩mo hacerlo.

### 7. Compilaci칩n del proyecto

Compile el proyecto de angular para que se pueda desplegar en la nube. Escriba lo siguiente dentro de la carpeta ra칤z del proyecto de angular:

```bash
ng build
```

Si salen advertencias no se preocupe, pero si sale un error asociado al tama침o del bundle, entonces debe modificar el archivo `angular.json` y en la parte de `budgets` aumentar los valores de `maximumError` y `maximumWarning`.

Esto crear치 una carpeta llamada `dist` y **dentro otra m치s con el nombre del proyecto**. Esta es la carpeta que Angular provee para la distribuci칩n de la aplicaci칩n.

### 8. Configuraci칩n del archivo `firebase.json`

Modifique el archivo `firebase.json` que fue creado al momento de ejecutar la inicializaci칩n de Firebase y cambie la propiedad `public` de la siguiente manera:

```json
{
  "hosting": {
    "public": "dist/nombre-proyecto-angular/browser",
    "ignore": [
      "firebase.json",
      "**/.*",
      "**/node_modules/**"
    ],
    "rewrites": [
      {
        "source": "**",
        "destination": "/index.html"
      }
    ]
  }
}
```

Abra la carpeta `dist` y verifique el nombre exacto de la carpeta que contiene los archivos compilados del proyecto de angular. Reemplace `nombre-proyecto-angular` por el nombre correcto.

### 9. Despliegue en Firebase

Finalmente haremos el despliegue, para esto, escribimos lo siguiente dentro de la carpeta ra칤z del proyecto de angular:

```bash
firebase deploy
```

### 10. Verificaci칩n de la URL p칰blica

Luego de algunos segundos, Firebase nos entregar치 un URL p칰blica en internet desde la cual podremos acceder a nuestro proyecto desde cualquier parte.

### 11. Prueba del frontend

Compruebe que todo funcione correctamente y que los servicios del backend est칠n operando con normalidad.

Recuerde que cada que haya un cambio en su c칩digo del frontend debe compilar el c칩digo con `ng build` y luego desplegarlo con `firebase deploy`.

> 丘멆잺 **Importante:** Tenga en cuenta que, en el backend desarrollado con Spring Boot, debe **configurar Spring Security para habilitar CORS** y permitir solicitudes desde la URL del frontend alojado en Firebase. Adem치s, aseg칰rese de actualizar las rutas de los servicios en Angular para que apunten correctamente a la **URL del backend desplegado en Railway**.

---

## Investigaci칩n

- Investigue qu칠 otros PaaS (como Railway o Firebase) existen. 쯊ienen planes gratuitos? 쯈u칠 tan f치ciles de usar son?