```
Programa de Ingenier칤a de Sistemas y Computaci칩n
Universidad del Quind칤o

T칤tulo: Despliegue en la nube
Duraci칩n estimada: 60
Docentes: Carlos Andr칠s Florez
Gu칤a: 21
```

# Despliegue en la nube

## 游꿢 Objetivo 

Desplegar una aplicaci칩n web completa (backend y frontend) en la nube usando servicios PaaS (Platform as a Service) como Render y Firebase.

---

## Conceptos b치sicos

Spring boot, Gradle, archivos de propiedades, Docker, Angular, GIT y Java.

---

## Contextualizaci칩n Te칩rica

La 칰ltima etapa en el desarrollo de software es el despliegue de la aplicaci칩n o del software a producci칩n. Para realizar esto existen diversas tecnolog칤as que van desde lo m치s manual hasta un proceso completamente automatizado. 

Una opci칩n es configurar de manera manual, por nuestros propios medios el servidor, instalar el software necesario, configurar puertos, servicios, protocolos, dominios, bases de datos, etc. y tambi칠n dar mantenimiento al hardware. Esta opci칩n suele ser muy costosa y requiere demasiado trabajo, por lo tanto, hay empresas que se encargan de hacer todo esto y ofrecen su trabajo como servicios (en la nube) a cambio de un precio que se puede pagar mensual, anual, cada tres a침os, etc. 

Este tipo de tecnolog칤a se divide en IaaS (Infrastructure as a service), PaaS (Platform as a Service) y SaaS (Software as a service).

- **SaaS** es simplemente software que utilizamos en el d칤a a d칤a. Este software es mantenido y actualizado por alguna empresa. Nosotros solo somos usuarios finales. Ejemplo: Google maps, aplicaciones de correo electr칩nico, Google Docs, Zoom, entre otros.

- **PaaS** permite desplegar aplicaciones hechas en alg칰n lenguaje de programaci칩n en alguna instancia de un servidor de una empresa. Este servicio solo proporciona una plataforma para desplegar la aplicaci칩n y la base de datos. Lo bueno, es que no tenemos que preocuparnos por montar el compilador, m치quinas virtuales, procesos, sistema operativo, etc. ya que el servicio se encarga de eso. Un ejemplo de PaaS es [Heroku](https://www.heroku.com/), [Render](https://render.com/), [Vercel](https://vercel.com/), [Fly.io](https://fly.io/), entre otros.

- **IaaS** permite controlar todos los aspectos de software de un servidor: puertos, protocolos, sistemas operativos, compiladores, etc. Este es el servicio m치s completo de todos, ya que no solo se queda en el despliegue de la aplicaci칩n sino en otros aspectos m치s t칠cnicos (de bajo nivel). Ejemplo: AWS, Azure, Google Cloud, Digital Ocean, etc.

En esta gu칤a nos enfocaremos en **PaaS**, ya que se adapta al contenido del espacio acad칠mico y es suficiente para lograr el despliegue de nuestro proyecto en internet. El servicio PaaS que usaremos es [Render](https://render.com/) para el backend y [Firebase](https://firebase.google.com/) para el frontend.

---

## Precauciones y Recomendaciones

Tenga cuidado con el manejo de ramas en su repositorio de GitHub. Para estar seguro, ejecute el comando git status dentro de la carpeta del proyecto y le dir치 en que rama est치. Una vez est칠 seguro de la rama de trabajo actual entonces puede hacer add, commit o push tranquilamente.

---

## Evaluaci칩n o Resultado

Se espera que el estudiante aprenda a utilizar la herramienta Render y Firebase para hacer un despliegue autom치tico de un proyecto (backend y frontend) en la nube. De igual manera, se espera que comprenda la utilidad de las ramas de Git para gestionar el c칩digo de un proyecto adecuadamente.

---

## Despliegue del backend

### 1. Creaci칩n de una nueva rama

Crear una nueva rama en el proyecto de Spring Boot. Para esto simplemente vaya a la carpeta del proyecto y con git escriba:

```bash
git checkout -b render
```

La idea de crear una nueva rama es no alterar el estado del proyecto, evitando as칤 da침ar la configuraci칩n, conexiones a base de datos y funcionamiento en general. La rama main (master) debe seguir estando igual a como estaba antes de esta gu칤a.

Si en cualquier momento desea regresar a la rama main (master) ejecute:

```bash
git checkout main
```

### 2. Creaci칩n del Dockerfile

Agregue un archivo en la ra칤z del proyecto principal que se llame `Dockerfile`. Y escriba lo siguiente.

```dockerfile
#
# Etapa de construcci칩n
#
FROM gradle:8.7-jdk21 AS build
USER gradle
WORKDIR /home/gradle/project

# Copiar solo archivos necesarios primero para aprovechar el cache de dependencias
COPY --chown=gradle:gradle build.gradle settings.gradle ./
COPY --chown=gradle:gradle gradle gradle
RUN gradle --no-daemon build -x test || return 0

# Copiar el resto del c칩digo fuente
COPY --chown=gradle:gradle . .

# Construir el archivo JAR
RUN gradle --no-daemon bootJar

#
# Etapa de empaquetado
#
FROM eclipse-temurin:21-jre
ENV APP_HOME=/app
WORKDIR ${APP_HOME}

# Argumento opcional para puerto
ARG PORT=8080
ENV PORT=${PORT}

# Copiar el JAR generado desde la etapa de construcci칩n
COPY --from=build /home/gradle/project/build/libs/*.jar app.jar

EXPOSE ${PORT}
ENTRYPOINT ["java", "-jar", "app.jar"]
```

Este archivo lo usa render para construir un contenedor de Docker con el proyecto compilado y as칤 poder ejecutarlo. Se destacan las dos fases: 

- La fase de construcci칩n del proyecto por medio de gradle.
- La fase de ejecuci칩n, la cual se encarga de poner a correr el proyecto de Spring Boot en la JVM (Java Virtual Machine) de Docker. 

La variable `${PORT}` ser치 definida m치s adelante desde la p치gina de configuraci칩n del proyecto de render.

### 3. Creaci칩n del archivo `system.properties`

Agregue un archivo en la ra칤z del proyecto principal que se llame `system.properties`. Y escriba lo siguiente.

```properties
java.runtime.version=21
```

Es necesario indicar qu칠 versi칩n de Java se va a usar para compilar el proyecto, aunque el Dockerfile define esta configuraci칩n, es una buena pr치ctica indicarlo en el archivo de propiedades. Las herramientas de despliegue suelen usar este archivo para elegir el JDK adecuado.

### 4. Modificaci칩n del `build.gradle`

Modifique el archivo `build.gradle` comentando o eliminando la siguiente l칤nea (si existe):

```kotlin
tasks.named('test') {
    useJUnitPlatform()
}
```

### 5. Actualizaci칩n de Gradle

Actualice gradle para que realice los cambios pertinentes. Esto se hace directamente en el archivo `build.gradle`.

### 6. Configuraci칩n de Supabase

Vaya a [Supabase](https://supabase.com/) e ingrese a su cuenta (o cree una nueva). Luego, cree un nuevo proyecto con el nombre que desee (por ejemplo *bookings*). En la siguiente pantalla seleccione la regi칩n m치s cercana a usted y asigne una contrase침a segura para la base de datos. Luego de esto, de click en el bot칩n "Create new project". Es importante que **recuerde la contrase침a asignada**, ya que la necesitar치 m치s adelante.

### 7. Configuraci칩n de la conexi칩n a Supabase

Con base en lo hecho en el punto anterior, **modifique las propiedades de conexi칩n** a la base de datos en el archivo `application.properties` para que apunten a la base de datos creada en Supabase. Tenga en cuenta que Supabase usa PostgreSQL como motor de base de datos.

**Conexi칩n a la base de datos de Supabase:**

Debe modificar las siguientes propiedades con los datos de su proyecto en Supabase:

```properties
spring.datasource.url=jdbc:postgresql://<host-supabase>:<port-supabase>/postgres
spring.datasource.username=<your-username>
spring.datasource.password=<your-password>
spring.datasource.driver-class-name=org.postgresql.Driver
```

Si usted en el archivo `application.properties` tiene la propiedad `server.port` debe quitarla.

**Driver de PostgreSQL:**

Agregue la siguiente dependencia en el archivo `build.gradle` si no est치 ya incluida y **borre la dependencia de MariaDB** o de cualquier otro motor de base de datos que est칠 usando:

```groovy
implementation 'org.postgresql:postgresql:42.7.8'
```

No olvide actualizar gradle despu칠s de hacer este cambio.

### 8. Commit y push a GitHub

Haga commit de sus ajustes y luego haga push al repositorio remoto en la rama render.

```bash
git push origin render
```

### 9. Creaci칩n de cuenta en Render

Cree una cuenta en [Render](https://render.com/), para esto use su cuenta de GitHub (autorice todo). Una vez conectado, ingrese al dashboard de render y vaya a la opci칩n **New** - **Web Service**.

### 10. Conexi칩n del repositorio

Luego, en la siguiente pantalla deje seleccionado **Git Provider**, busque su repositorio del backend del proyecto y de click en el bot칩n Connect.

### 11. Configuraci칩n del servicio

En la siguiente pantalla elija a **Docker como lenguaje**, y seleccione la rama creada en el primer punto de esta gu칤a (*render*). En tipo de instancia elija **Free**. Por 칰ltimo, asigne la variable de entorno `PORT` con el valor `8080`.

Luego de click en el bot칩n **Deploy Web Service**.

### 12. Monitoreo de eventos

Vaya a la opci칩n *Events* (men칰 izquierdo del dashboard), all칤 podr치 ver todos los despliegues que se han realizado a lo largo del tiempo.

### 13. Revisi칩n de logs

Adicionalmente, puede ir a la opci칩n *Logs* para ver la **consola de despliegue en tiempo real**, all칤 se muestran los logs tanto de construcci칩n como los de despliegue. Tenga en cuenta que el despliegue puede tardar varios minutos.

En el log de despliegue debe salir el mensaje de Spring y al final debe mostrar: **Tomcat started on port 8080 (http)** indicando que todo ha salido bien y el despliegue ha quedo listo.

### 14. URL del backend desplegado

Tenga en cuenta que la url que aparece bajo el nombre del proyecto se convertir치 en la ruta del backend desplegado en la nube (ya no usaremos m치s localhost).

### 15. Prueba del backend

Acceda a dicha ruta y pruebe que funciona correctamente enviando peticiones (usando Postman por ejemplo). **La capa gratuita de render hace que el backend deje de funcionar debido a la inactividad, lo que puede retrasar las solicitudes 50 segundos o m치s.**

---

## Despliegue del frontend

### 1. Creaci칩n de nueva rama

En el proyecto de angular cree una nueva rama con el nombre que desee. Por ejemplo *firebase*:

```bash
git checkout -b firebase
```

### 2. Actualizaci칩n de URLs de servicios

Dado que el proyecto de Spring Boot (backend) ya est치 desplegado en render entonces modifique las url de los servicios para que en lugar de apuntar a [http://localhost:8080/](http://localhost:8080/) ahora lo haga a la url de render.

Si est치 usando archivos de constantes (`environments`) entonces modifique el archivo `environment` de producci칩n para que apunte a la url de render.

### 3. Creaci칩n de proyecto en Firebase

Vaya a [Firebase](https://console.firebase.google.com/) y cree un nuevo proyecto con el nombre de su preferencia. En la siguiente pantalla deshabilite Gemini y Google Analytics y de clic en "Crear Proyecto".

### 4. Instalaci칩n de Firebase Tools

Instale la herramienta de firebase en su computador por medio de npm. Escriba lo siguiente en el cmd de Windows o en la terminal de GNU/Linux o MacOS:

```bash
npm install -g firebase-tools
```

### 5. Login en Firebase

Una vez instalado, escriba ahora lo siguiente para loguearse en *firebase* desde su computador:

```bash
firebase login
```

Se abrir치 una ventana en el navegador para que inicie sesi칩n con su cuenta de Google (la misma que us칩 para crear el proyecto en Firebase).

### 6. Inicializaci칩n de Firebase en el proyecto

Ahora, en la carpeta ra칤z de su proyecto de angular escriba lo siguiente:

```bash
firebase init
```

Al escribir esto aparecer치 un asistente en consola para configurar el proyecto local de angular.

A la primera pregunta elegimos la opci칩n "Hosting: Set up deployments for static web apps".

Luego elegimos "Use an existing project". Y seleccionamos el proyecto creado anteriormente. Finalmente en la parte de Hosting Setup escribimos lo siguiente en cada pregunta:

- **What do you want to use as your public directory?** solo presione Enter (deje el valor por defecto `public`)
- **Configure as a single-page app (rewrite all urls to /index.html)?** Y
- **Set up automatic builds and deploys with GitHub?** n (opcional)

Una vez terminado (cuando nos salga el mensaje "Firebase initialization complete!") aparecer치n dos archivos en el proyecto local, uno llamado `.firebaserc` y otro `firebase.json` que contienen la configuraci칩n con el servidor de Firebase con el proyecto. Tambi칠n se crear치 una carpeta `public` con un `index.html`, este archivo no lo vamos a usar ya que Angular construye su propio `index.html` al compilar la aplicaci칩n. Este archivo se puede borrar.

> 丘멆잺 **Nota:** Si lo desea, puede habilitar la opci칩n "Set up automatic builds and deploys with GitHub". Aunque no es obligatorio, al activarla se realizar치 el despliegue autom치ticamente cada vez que haga push a la rama configurada de Firebase. Investigue c칩mo hacerlo.

### 7. Compilaci칩n del proyecto

Compile el proyecto de angular para que se pueda desplegar en la nube. Escriba lo siguiente dentro de la carpeta ra칤z del proyecto de angular:

```bash
ng build
```

Esto crear치 una carpeta llamada `dist` y **dentro otra m치s con el nombre del proyecto**. Esta es la carpeta que Angular provee para la distribuci칩n de la aplicaci칩n.

### 8. Configuraci칩n del archivo `firebase.json`

Modifique el archivo `firebase.json` que fue creado al momento de ejecutar la inicializaci칩n de Firebase y cambie la propiedad `public` de la siguiente manera:

```json
{
  "hosting": {
    "public": "dist/<nombre-proyecto-angular>/browser",
    "ignore": [
      "firebase.json",
      "**/.*",
      "**/node_modules/**"
    ],
    "rewrites": [
      {
        "source": "**",
        "destination": "/index.html"
      }
    ]
  }
}
```

Recuerde revisar el nombre de la carpeta que se cre칩 dentro de la carpeta `dist`, ya que este es el nombre que debe poner en `public`. De esta manera, Firebase desplegar치 la aplicaci칩n usando los archivos que est치n all칤 dentro.

### 9. Despliegue en Firebase

Finalmente haremos el despliegue, para esto, escribimos lo siguiente dentro de la carpeta ra칤z del proyecto de angular:

```bash
firebase deploy
```

### 10. Verificaci칩n de la URL p칰blica

Luego de algunos segundos, Firebase nos entregar치 un URL p칰blica en internet desde la cual podremos acceder a nuestro proyecto desde cualquier parte.

### 11. Prueba del frontend

Compruebe que todo funcione correctamente y que los servicios del backend est칠n operando con normalidad.

Recuerde que cada que haya un cambio en su c칩digo del frontend debe compilar el c칩digo con `ng build` y luego desplegarlo con `firebase deploy`.

> 丘멆잺 **Importante:** Tenga en cuenta que, en el backend desarrollado con Spring Boot, debe **configurar Spring Security para habilitar CORS** y permitir solicitudes desde la URL del frontend alojado en Firebase. Adem치s, aseg칰rese de actualizar las rutas de los servicios en Angular para que apunten correctamente a la **URL del backend desplegado en Render**.

---

## Investigaci칩n

- Investigue qu칠 otros PaaS (como Render o Firebase) existen. 쯊ienen planes gratuitos? 쯈u칠 tan f치ciles de usar son?