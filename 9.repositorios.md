<!-- Aqu铆 cargamos Mermaid.js --> 
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script> 
<script> document.addEventListener("DOMContentLoaded", function() { mermaid.initialize({ startOnLoad: true }); }); </script>

```
Programa de Ingenier铆a de Sistemas y Computaci贸n
Universidad del Quind铆o

T铆tulo: Repositorios en Spring Boot
Duraci贸n estimada: 120
Docentes: Carlos Andr茅s Florez, Christian Andr茅s Candela
Gu铆a: 09
```

# Repositorios en Spring Boot

##  Objetivo
Comprender qu茅 son los repositorios en Spring Boot, as铆 como su importancia en el acceso y consulta de datos en un proyecto empresarial.

---

## Conceptos B谩sicos
- **Bases de Datos SQL**: MariaDB como ejemplo principal.
- **Java**: Lenguaje de programaci贸n orientado a objetos.
- **Spring Data JPA**: M贸dulo de Spring para interactuar con bases de datos SQL.

---

## Contextualizaci贸n Te贸rica

La capa de persistencia es esencial para modelar los datos de un proyecto de software y gestionar el acceso a la informaci贸n almacenada en la base de datos. Esta capa depende de los requisitos del negocio, que definen las tablas o colecciones necesarias para almacenar y consultar datos.

En **Spring Boot**, las entidades representan registros en una base de datos SQL (como MariaDB) y se mapean a clases Java. Los repositorios act煤an como intermediarios entre la l贸gica de negocio y la base de datos, proporcionando m茅todos para operaciones CRUD (Crear, Leer, Actualizar, Eliminar).

### **驴Qu茅 es un Repositorio?**
Un **repositorio** en Spring Boot es una interfaz que abstrae el acceso a datos, permitiendo separar la l贸gica de negocio de la l贸gica de acceso a datos. En el contexto de **Spring Data JPA**, los repositorios extienden la interfaz `JpaRepository`, que proporciona m茅todos predefinidos para interactuar con bases de datos SQL.

### 驴Por qu茅 son importantes los repositorios?

1. **Abstracci贸n de la l贸gica de acceso a datos**: Los repositorios permiten separar la l贸gica de negocio de la l贸gica de acceso a datos, lo que facilita el mantenimiento y la escalabilidad del c贸digo.
2. **Reducci贸n de c贸digo repetitivo**: Spring Data JPA proporciona m茅todos predefinidos (como `save`, `findById`, `delete`, etc.), lo que reduce la necesidad de escribir c贸digo repetitivo para operaciones comunes.
3. **Facilidad de integraci贸n**: Los repositorios se integran con otras capas de la aplicaci贸n, como los servicios y controladores, gracias a la inyecci贸n de dependencias de Spring.

### 驴Qu茅 es `JpaRepository`?

`JpaRepository` es una interfaz proporcionada por **Spring Data JPA** que extiende de `CrudRepository`. Esta interfaz ofrece m茅todos predefinidos para realizar operaciones CRUD en una base de datos SQL. Al extender esta interfaz, es posible crear repositorios personalizados que hereden estos m茅todos y agregar consultas espec铆ficas seg煤n las necesidades del proyecto.

A continuaci贸n se listan algunos m茅todos disponibles en un `JpaRepository`.

| M茅todo            | Descripci贸n                                                                 |
   |-------------------|-----------------------------------------------------------------------------|
   | `save(objeto)`    | Si el registro es nuevo lo guarda en la tabla correspondiente de la base de datos. Si ya existe un registro con el mismo id entonces lo actualiza. |
   | `delete(objeto)`  | Elimina un objeto que est茅 en la base de datos.                             |
   | `deleteById(id)`  | Elimina un objeto que est茅 en la base de datos dado el id.                  |
   | `findAll()`       | Retorna una lista con todos los registros que est谩n almacenados en una tabla en la base de datos. |
   | `findById(id)`    | Retorna un registro que est谩 en la base de datos dado su id.                |
   | `count()`         | Devuelve la cantidad de registros que tiene una tabla.                      |
   | `exists(objeto)`  | Retorna un boolean indicando si el objeto existe en la base de datos.       |
   | `existsById(id)`  | Retorna un boolean indicando si el objeto existe en la base de datos dado el id. |

### **Consultas Personalizadas**

Cuando se requieren consultas m谩s espec铆ficas, pueden definirse en los repositorio. Spring Data JPA permite inferir consultas autom谩ticamente a partir de nombres de m茅todos.

Ejemplo:

```java
Optional<User> findUserByEmail(String email);
```

Por otro lado, las consultas m谩s complejas, pueden ser definidas usando anotaciones como `@Query`. 


### Arquitectura del acceso a la informaci贸n en Spring Boot

Dentro de la arquitectura de una aplicaci贸n Spring Boot, los repositorios forman parte de la capa de persistencia. La estructura t铆pica incluye:
- **Controladores**: Manejan las solicitudes HTTP y dirigen las operaciones a los servicios correspondientes.
- **Servicios**: Contienen la l贸gica de negocio y utilizan los repositorios para acceder a los datos.
- **Repositorios**: Gestionan el acceso a la base de datos y proporcionan m茅todos para operaciones CRUD y consultas personalizadas.
- **Entidades**: Representan las tablas en la base de datos y se mapean a clases Java.

### Componentes en Spring Boot

En Spring Boot se denomina componente a los elementos que son inicializados y gestionados autom谩ticamente por Spring Boot seg煤n su prop贸sito. Los componentes se gestionan mediante anotaciones que indican su funci贸n dentro de la aplicaci贸n:

- **@Component**: Anotaci贸n de prop贸sito general que indica que una clase es un componente de Spring.
- **@Repository**: Indica que una clase es un repositorio, es decir, un componente que gestiona el acceso a datos.
- **@Service**: Indica que una clase contiene la l贸gica de negocio y utiliza repositorios para acceder a los datos.
- **@Controller**: Indica que una clase es un controlador que maneja las solicitudes HTTP y las dirige a los servicios correspondientes.
  
<div class="mermaid" style="text-align: center;">
---
title: Componentes en Spring Boot
---
classDiagram
    Component <|-- Controller
    Component <|-- Service
    Component <|-- Repository
</div>

---

## Precauciones y Recomendaciones

- Recuerde verificar que tiene instalado el JDK de Java (preferiblemente la versi贸n 21). 
- Aseg煤rese de tener el servidor de base de datos en ejecuci贸n.
- Verifique que las dependencias en el archivo `gradle.build` est茅n correctamente configuradas.

---

## Evaluaci贸n o Resultado

Se espera que el estudiante logre crear repositorios para acceder a la base de datos, tanto para guardar registros como modificarlos, eliminarlos y consultarlos.

---

## Procedimiento

### 1. Continuaci贸n del proyecto
En esta gu铆a, continuaremos con el ejemplo de la tienda que hemos estado desarrollando en la gu铆a anterior.

### 2. Crear paquete de repositorios
Cree el paquete `co.edu.uniquindio.application.repositories` en la carpeta `main/java`.

### 3. Crear interface `UserRepository`
Dentro del paquete creado, cree una interface llamada `UserRepository` que extienda de `JpaRepository`. Esta interfaz debe tener la anotaci贸n `@Repository`.

```java
package co.edu.uniquindio.application.repositories;

import co.edu.uniquindio.application.model.entity.User;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface UserRepository extends JpaRepository<User, String>{
}
```

**NOTA:** `JpaRepository` es gen茅rico, por lo que debemos definir:
1. El tipo de dato de la entidad (`User`)
2. El tipo de dato de su `@Id` (`String`)

Por cada `@Entity` ser谩 necesario crear un repositorio.

### 4. Modificar el Servicio de Negocio `UserServiceImpl`

Modifique el Servicio de Negocio `UserServiceImpl` para inyectar el repositorio `UserRepository`. Ejemplo:


```java
package co.edu.uniquindio.application.services.impl;

import co.edu.uniquindio.application.repositories.UserRepository;
import co.edu.uniquindio.application.services.UserService;
import co.edu.uniquindio.application.mappers.UserMapper;
import lombok.RequiredArgsConstructor;

@Service
@RequiredArgsConstructor
public class UserServiceImpl implements UserService{
    private final UserRepository userRepository;
    private final UserMapper userMapper;
}
```

El repositorio `UserRepository` se inyecta en el servicio de negocio mediante el uso de la anotaci贸n `@RequiredArgsConstructor` de Lombok, que genera un constructor con los argumentos necesarios para inicializar los campos `final`.

## 5. Modificar los m茅todos del servicio de negocio `UserServiceImpl`

Ahora, modifique los m茅todos del servicio de negocio `UserServiceImpl` para utilizar el repositorio `UserRepository` en lugar de la lista en memoria. 

**Crear usuario:**

Para el m茅todo `create`, utilice el m茅todo `save` del repositorio para almacenar el usuario en la base de datos. As铆:

```java
@Override
public void create(CreateUserDTO userDTO) throws Exception {
    //Validaci贸n del email
    if(isEmailDuplicated(userDTO.email())){
        throw new ValueConflictException("El correo electr贸nico ya est谩 en uso.");
    }

    //Transformaci贸n del DTO a User
    User newUser = userMapper.toEntity(userDTO);
    newUser.setPassword(encode(userDTO.password()));

    //Almacenamiento del usuario
    userRepository.save(newUser);
}

private boolean isEmailDuplicated(String email){
    return userRepository.findByEmail(email).isPresent();
}
```

**Obtener un usuario:**

Para el m茅todo `get`, utilice el m茅todo `findById` del repositorio para recuperar el usuario de la base de datos. As铆:

```java
@Override
public UserDTO get(String id) throws Exception {
    //Recuperaci贸n del usuario
    Optional<User> userOptional = userRepository.findById(id);

    //Validaci贸n del usuario
    if (userOptional.isEmpty()) {
        throw new Exception("Usuario no encontrado.");
    }

    //Transformaci贸n del usuario a DTO
    return userMapper.toUserDTO(userOptional.get());
}
```

El m茅todo `findById()` siempre retorna un `Optional`, que puede contener un objeto o estar vac铆o. En este caso, se verifica si el usuario existe antes de proceder a mapearlo a un DTO.

**Eliminar un usuario:**

Para el m茅todo `delete`, utilice el m茅todo `delete` o `deleteById` del repositorio para eliminar el usuario de la base de datos. As铆:

```java
@Override
public void delete(String id) throws Exception {
    //Recuperaci贸n del usuario
    Optional<User> userOptional = userRepository.findById(id);
    
    //Validaci贸n del usuario
    if (userOptional.isEmpty()) {
        throw new Exception("Usuario no encontrado.");
    }

    //Eliminaci贸n del usuario
    userRepository.delete(userOptional.get());
}
```

**Actualizar un usuario:**

Para el m茅todo `update`, utilice el m茅todo `save` del repositorio para actualizar el usuario en la base de datos. As铆:

```java
@Override
public void edit(String id, EditUserDTO userDTO) throws Exception {
    //Recuperaci贸n del usuario
    Optional<User> userOptional = userRepository.findById(id);

    //Validaci贸n del usuario
    if (userOptional.isEmpty()) {
        throw new Exception("Usuario no encontrado.");
    }

    //Se obtiene el usuario que est谩 dentro del Optional
    User user = userOptional.get();

    //Actualizaci贸n de los datos del usuario
    user.setName(userDTO.name());
    user.setPhone(userDTO.phone());
    user.setDateBirth(userDTO.dateBirth());
    user.setPhotoUrl(userDTO.photoUrl());

    //Almacenamiento del usuario
    userRepository.save(user);
}
```

**Listar todos los usuarios:**

Para el m茅todo `listAll`, utilice el m茅todo `findAll` del repositorio para recuperar todos los usuarios de la base de datos. As铆:

```java
@Override
public List<UserDTO> listAll() {
    return userRepository.findAll()
            .stream().map(userMapper::toUserDTO)
            .toList();
}
```

> 锔 **Importante:** note que se est谩 haciendo uso del repositorio aun cuando no se posee una implementaci贸n concreta del mismo.

### 6. Probar el servicio de negocio para usuarios

Ejecute su aplicaci贸n y verifique su correcto funcionamiento usando herramientas como [archivos Http Request](https://www.jetbrains.com/help/idea/http-client-in-product-code-editor.html), [Hugo](https://gohugo.io/), [Postman](https://www.postman.com/) o [Soap UI](https://www.soapui.org/). 

En este caso se usar谩 archivos `http`. Si no lo tiene, cree un archivo llamado `users.http` en la carpeta `src/main/resources` y agregue el siguiente contenido:

```bash
### Crear un usuario
POST http://localhost:8080/api/users
Content-Type: application/json

{
  "name": "Carlos",
  "phone": "121212",
  "email": "carlos@email.com",
  "password": "12345678",
  "photoUrl": "",
  "dateBirth": "2000-08-22",
  "role": "GUEST"
}
```
Ejecute la petici贸n y verifique que el usuario se haya creado correctamente en la base de datos.

> 锔 **Importante:** Agregue m谩s peticiones en el archivo `users.http` para probar los dem谩s m茅todos del servicio de negocio.

### 7. Crear repositorio `PlaceRepository`

Cree repositorio para los alojamientos, (asumiendo que la llave primaria de la entidad `Place` es de tipo `Long`) el repositorio quedar铆a as铆:

```java
package co.edu.uniquindio.application.repositories;

import co.edu.uniquindio.application.model.entity.Place;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface PlaceRepository extends JpaRepository<Place, Long>{
}
```

### 8. Crear el resto de repositorios

Cree los repositorios para las entidades del proyecto final. Debe seguir la misma l贸gica usada para crear el repositorio del usuario y de los alojamientos.

### 9. Implementar servicios de negocio

Implemente los servicios de negocio para cada uno de sus repositorios para permitir al menos las operaciones CRUD.

### 10. Crear controladores REST faltantes

Cree los controladores Rest para aquellos servicios de negocio que a煤n no lo tengan.

### 11. Guardar cambios en Git
Recuerde hacer commit en su repositorio de Git con todo lo realizado en esta gu铆a.

---

## Para la pr贸xima clase

- De ahora en adelante, se trabajar谩 con el modelo de clases del proyecto final. Crear las clases que se mapear谩n como documentos en la base de datos, incluyendo sus respectivas propiedades e implementar los repositorios correspondientes.

- **Investigar** sobre la inferencia de queries en Spring Boot JPA, a qu茅 se refiere y para qu茅 sirve.

---

## Referencias Bibliogr谩ficas

1. MongoDB Inc. "Introduction to MongoDB." [https://www.mongodb.com](https://www.mongodb.com)
2. ECMA International. "The JSON Data Interchange Format." [https://www.json.org](https://www.json.org)
3. Oracle. "The Java Tutorials." [https://docs.oracle.com/javase/tutorial/](https://docs.oracle.com/javase/tutorial/)
4. Spring Team. "Spring Data MongoDB." [https://spring.io/projects/spring-data-mongodb](https://spring.io/projects/spring-data-mongodb)
5. Fowler, Martin. "Patterns of Enterprise Application Architecture." Addison-Wesley, 2002.
6. Spring Team. "Repositories in Spring Data." [https://docs.spring.io/spring-data/mongodb/reference/repositories.html](https://docs.spring.io/spring-data/mongodb/reference/repositories.html)
7. Baeldung. "Introduction to Spring Data MongoDB." [https://www.baeldung.com/spring-data-mongodb](https://www.baeldung.com/spring-data-mongodb)
8. Spring Team. "Query Methods in Spring Data." [https://docs.spring.io/spring-data/mongodb/reference/repositories/query-methods-details.html](https://docs.spring.io/spring-data/mongodb/reference/repositories/query-methods-details.html)
9.  Baeldung. "Spring Data MongoDB Queries." [https://www.baeldung.com/queries-in-spring-data-mongodb](https://www.baeldung.com/queries-in-spring-data-mongodb)
10. Spring Team. "MongoDB-specific Query Methods."[https://docs.spring.io/spring-data/mongodb/reference/mongodb/repositories/query-methods.html](https://docs.spring.io/spring-data/mongodb/reference/mongodb/repositories/query-methods.html)