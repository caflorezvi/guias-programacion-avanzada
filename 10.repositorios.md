<!-- Aqu√≠ cargamos Mermaid.js --> 
<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script> 
<script> document.addEventListener("DOMContentLoaded", function() { mermaid.initialize({ startOnLoad: true }); }); </script>

```
Programa de Ingenier√≠a de Sistemas y Computaci√≥n
Universidad del Quind√≠o

T√≠tulo: Repositorios en Spring Boot
Duraci√≥n estimada: 120
Docentes: Carlos Andr√©s Florez, Christian Andr√©s Candela
Gu√≠a: 10
```

# Repositorios en Spring Boot

## üéØ Objetivo
Comprender qu√© son los repositorios en Spring Boot, as√≠ como su importancia en el acceso y consulta de datos en un proyecto empresarial.

---

## Conceptos B√°sicos
- **Bases de Datos SQL**: MariaDB como ejemplo principal.
- **Java**: Lenguaje de programaci√≥n orientado a objetos.
- **Spring Data JPA**: M√≥dulo de Spring para interactuar con bases de datos SQL.

---

## Contextualizaci√≥n Te√≥rica

La capa de persistencia es esencial para modelar los datos de un proyecto de software y gestionar el acceso a la informaci√≥n almacenada en la base de datos. Esta capa depende de los requisitos del negocio, que definen las tablas o colecciones necesarias para almacenar y consultar datos.

En **Spring Boot**, las entidades representan registros en una base de datos SQL (como MariaDB) y se mapean a clases Java. Los repositorios act√∫an como intermediarios entre la l√≥gica de negocio y la base de datos, proporcionando m√©todos para operaciones CRUD (Crear, Leer, Actualizar, Eliminar).

### **¬øQu√© es un Repositorio?**
Un **repositorio** en Spring Boot es una interfaz que abstrae el acceso a datos, permitiendo separar la l√≥gica de negocio de la l√≥gica de acceso a datos. En el contexto de **Spring Data JPA**, los repositorios extienden la interfaz `JpaRepository`, que proporciona m√©todos predefinidos para interactuar con bases de datos SQL.

### ¬øPor qu√© son importantes los repositorios?

1. **Abstracci√≥n de la l√≥gica de acceso a datos**: Los repositorios permiten separar la l√≥gica de negocio de la l√≥gica de acceso a datos, lo que facilita el mantenimiento y la escalabilidad del c√≥digo.
2. **Reducci√≥n de c√≥digo repetitivo**: Spring Data JPA proporciona m√©todos predefinidos (como `save`, `findById`, `delete`, etc.), lo que reduce la necesidad de escribir c√≥digo repetitivo para operaciones comunes.
3. **Facilidad de integraci√≥n**: Los repositorios se integran con otras capas de la aplicaci√≥n, como los servicios y controladores, gracias a la inyecci√≥n de dependencias de Spring.

### ¬øQu√© es `JpaRepository`?

`JpaRepository` es una interfaz proporcionada por **Spring Data JPA** que extiende de `CrudRepository`. Esta interfaz ofrece m√©todos predefinidos para realizar operaciones CRUD en una base de datos SQL. Al extender esta interfaz, es posible crear repositorios personalizados que hereden estos m√©todos y agregar consultas espec√≠ficas seg√∫n las necesidades del proyecto.

A continuaci√≥n se listan algunos m√©todos disponibles en un `JpaRepository`.

| M√©todo            | Descripci√≥n                                                                 |
   |-------------------|-----------------------------------------------------------------------------|
   | `save(objeto)`    | Si el registro es nuevo lo guarda en la tabla correspondiente de la base de datos. Si ya existe un registro con el mismo id entonces lo actualiza. |
   | `delete(objeto)`  | Elimina un objeto que est√© en la base de datos.                             |
   | `deleteById(id)`  | Elimina un objeto que est√© en la base de datos dado el id.                  |
   | `findAll()`       | Retorna una lista con todos los registros que est√°n almacenados en una tabla en la base de datos. |
   | `findById(id)`    | Retorna un registro que est√° en la base de datos dado su id.                |
   | `count()`         | Devuelve la cantidad de registros que tiene una tabla.                      |
   | `exists(objeto)`  | Retorna un boolean indicando si el objeto existe en la base de datos.       |
   | `existsById(id)`  | Retorna un boolean indicando si el objeto existe en la base de datos dado el id. |

### **Consultas Personalizadas**

Cuando se requieren consultas m√°s espec√≠ficas, pueden definirse en los repositorio. Spring Data JPA permite inferir consultas autom√°ticamente a partir de nombres de m√©todos.

Ejemplo:

```java
Optional<User> findUserByEmail(String email);
```

Por otro lado, las consultas m√°s complejas, pueden ser definidas usando anotaciones como `@Query`. 


### Arquitectura del acceso a la informaci√≥n en Spring Boot

Dentro de la arquitectura de una aplicaci√≥n Spring Boot, los repositorios forman parte de la capa de persistencia. La estructura t√≠pica incluye:
- **Controladores**: Manejan las solicitudes HTTP y dirigen las operaciones a los servicios correspondientes.
- **Servicios**: Contienen la l√≥gica de negocio y utilizan los repositorios para acceder a los datos.
- **Repositorios**: Gestionan el acceso a la base de datos y proporcionan m√©todos para operaciones CRUD y consultas personalizadas.
- **Entidades**: Representan las tablas en la base de datos y se mapean a clases Java.

  
<div class="mermaid" style="text-align: center;">
---
title: Componentes en Spring Boot
---
classDiagram
    Component <|-- Controller
    Component <|-- Service
    Component <|-- Repository

</div>

En la gu√≠a anterior se implementaron los **servicios de negocio** usando `@Service`, que son los encargados de procesar las reglas del negocio y manejar la l√≥gica empresarial.

En esta gu√≠a se implementar√°n los **repositorios**, que, como se mencion√≥ anteriormente, son los encargados de interactuar con la base de datos para realizar operaciones CRUD y consultas espec√≠ficas.

---

## Precauciones y Recomendaciones

- Recuerde verificar que tiene instalado el JDK de Java (preferiblemente la versi√≥n 21). 
- Aseg√∫rese de tener el servidor de base de datos en ejecuci√≥n.
- Verifique que las dependencias en el archivo `build.gradle` est√©n correctamente configuradas.

---

## Evaluaci√≥n o Resultado

Se espera que el estudiante logre crear repositorios para acceder a la base de datos, tanto para guardar registros como modificarlos, eliminarlos y consultarlos.

---

## Procedimiento

Continuaremos trabajando en el proyecto final del espacio acad√©mico que iniciamos en las gu√≠as anteriores. Si no ha completado la gu√≠a anterior, por favor h√°galo antes de continuar con esta.

### 1. Crear paquete de repositorios
Cree el paquete `co.edu.uniquindio.application.repositories` en la carpeta `main/java`.

### 2. Crear interface `UserRepository`
Dentro del paquete creado en el punto anterior, cree una interface llamada `UserRepository` que extienda de `JpaRepository`. Esta interfaz debe tener la anotaci√≥n `@Repository`, as√≠:

```java
package co.edu.uniquindio.application.repositories;

import co.edu.uniquindio.application.model.entity.User;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface UserRepository extends JpaRepository<User, String>{
}
```

Tenga en cuenta que `JpaRepository` es gen√©rico, por lo que debemos definir:
1. El tipo de dato de la entidad (`User`)
2. El tipo de dato de su `@Id` (`String`)

Por cada `@Entity` ser√° necesario crear un repositorio.

### 3. Modificar el Servicio de Negocio `UserServiceImpl`

Modifique el Servicio de Negocio `UserServiceImpl` para inyectar el repositorio `UserRepository`. Ejemplo:


```java
package co.edu.uniquindio.application.services.impl;

import co.edu.uniquindio.application.repositories.UserRepository;
import co.edu.uniquindio.application.services.UserService;
import co.edu.uniquindio.application.mappers.UserMapper;
import lombok.RequiredArgsConstructor;

@Service
@RequiredArgsConstructor
public class UserServiceImpl implements UserService{
    private final UserRepository userRepository;
    private final UserMapper userMapper;
}
```

El repositorio `UserRepository` se inyecta en el servicio de negocio mediante el uso de la anotaci√≥n `@RequiredArgsConstructor` de Lombok, que genera un constructor con los argumentos necesarios para inicializar los campos `final`.

## 4. Modificar los m√©todos del servicio de negocio `UserServiceImpl`

Ahora, modifique los m√©todos del servicio de negocio `UserServiceImpl` para utilizar el repositorio `UserRepository` en lugar de la lista en memoria. 

Borre el map `userStore` que se usaba para almacenar los usuarios en memoria y haga las siguientes modificaciones en cada m√©todo:

### Crear usuario:

Para el m√©todo `create`, utilice el m√©todo `save` del repositorio para almacenar el usuario en la base de datos. As√≠:

```java
@Override
public void create(CreateUserDTO userDTO) throws Exception {
    //Validaci√≥n del email
    if(isEmailDuplicated(userDTO.email())){
        throw new ValueConflictException("El correo electr√≥nico ya est√° en uso.");
    }

    //Transformaci√≥n del DTO a User
    User newUser = userMapper.toEntity(userDTO);
    newUser.setPassword(encode(userDTO.password()));

    //Almacenamiento del usuario
    userRepository.save(newUser);
}

private boolean isEmailDuplicated(String email){
    return userRepository.findByEmail(email).isPresent();
}
```

Tenga en cuenta que es necesario crear el m√©todo `findByEmail` en el repositorio `UserRepository` para validar si el correo electr√≥nico ya est√° en uso. Cree el m√©todo as√≠:

```java
Optional<User> findByEmail(String email);
```

Dado que la entidad `User` tiene un atributo `email`, Spring Data JPA infiere autom√°ticamente la consulta necesaria para buscar un usuario por su correo electr√≥nico.

### Obtener un usuario:

Para el m√©todo `get`, utilice el m√©todo `findById` del repositorio para recuperar el usuario de la base de datos. As√≠:

```java
@Override
public UserDTO get(String id) throws Exception {
    //Recuperaci√≥n del usuario
    Optional<User> userOptional = userRepository.findById(id);

    //Validaci√≥n del usuario
    if (userOptional.isEmpty()) {
        throw new Exception("Usuario no encontrado.");
    }

    //Transformaci√≥n del usuario a DTO
    return userMapper.toUserDTO(userOptional.get());
}
```

El m√©todo `findById()` siempre retorna un `Optional`, que puede contener un objeto o estar vac√≠o. En este caso, se verifica si el usuario existe antes de proceder a mapearlo a un DTO.

### Eliminar un usuario:

Para el m√©todo `delete`, utilice el m√©todo `delete` o `deleteById` del repositorio para eliminar el usuario de la base de datos. As√≠:

```java
@Override
public void delete(String id) throws Exception {
    //Recuperaci√≥n del usuario
    Optional<User> userOptional = userRepository.findById(id);
    
    //Validaci√≥n del usuario
    if (userOptional.isEmpty()) {
        throw new Exception("Usuario no encontrado.");
    }

    //Eliminaci√≥n del usuario
    userRepository.delete(userOptional.get());
}
```

### Actualizar un usuario:

Para el m√©todo `update`, utilice el m√©todo `save` del repositorio para actualizar el usuario en la base de datos. As√≠:

```java
@Override
public void edit(String id, EditUserDTO userDTO) throws Exception {
    //Recuperaci√≥n del usuario
    Optional<User> userOptional = userRepository.findById(id);

    //Validaci√≥n del usuario
    if (userOptional.isEmpty()) {
        throw new Exception("Usuario no encontrado.");
    }

    //Se obtiene el usuario que est√° dentro del Optional
    User user = userOptional.get();

    //Actualizaci√≥n de los datos del usuario
    user.setName(userDTO.name());
    user.setPhone(userDTO.phone());
    user.setDateBirth(userDTO.dateBirth());
    user.setPhotoUrl(userDTO.photoUrl());

    //Almacenamiento del usuario
    userRepository.save(user);
}
```

### Listar todos los usuarios:

Para el m√©todo `listAll`, utilice el m√©todo `findAll` del repositorio para recuperar todos los usuarios de la base de datos. As√≠:

```java
@Override
public List<UserDTO> listAll() {
    return userRepository.findAll()
            .stream().map(userMapper::toUserDTO)
            .toList();
}
```

> ‚ö†Ô∏è **Importante:** note que se est√° haciendo uso del repositorio aun cuando no se posee una implementaci√≥n concreta del mismo.

### 5. Probar el servicio de negocio para usuarios

Ejecute su aplicaci√≥n y verifique su correcto funcionamiento usando herramientas como [archivos Http Request](https://www.jetbrains.com/help/idea/http-client-in-product-code-editor.html), [Hugo](https://gohugo.io/), [Postman](https://www.postman.com/) o [Soap UI](https://www.soapui.org/). 

En este caso se usar√° archivos `http`. Si no lo tiene, cree un archivo llamado `users.http` en la carpeta `src/main/resources` y agregue el siguiente contenido:

```bash
### Crear un usuario
POST http://localhost:8080/api/users
Content-Type: application/json

{
  "name": "Carlos",
  "phone": "121212",
  "email": "carlos@email.com",
  "password": "12345678",
  "photoUrl": "",
  "dateBirth": "2000-08-22",
  "role": "GUEST"
}
```
Ejecute la petici√≥n y verifique que el usuario se haya creado correctamente en la base de datos.

> ‚ö†Ô∏è **Importante:** Agregue m√°s peticiones en el archivo `users.http` para probar los dem√°s m√©todos del servicio de negocio.

### 6. Crear repositorio `PlaceRepository`

Cree repositorio para los alojamientos, (asumiendo que la llave primaria de la entidad `Place` es de tipo `Long`) el repositorio quedar√≠a as√≠:

```java
package co.edu.uniquindio.application.repositories;

import co.edu.uniquindio.application.model.entity.Place;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.stereotype.Repository;

@Repository
public interface PlaceRepository extends JpaRepository<Place, Long>{
}
```

### 7. Crear el resto de repositorios

Cree los dem√°s repositorios para las entidades del proyecto final. Debe seguir la misma l√≥gica usada para crear el repositorio del usuario y de los alojamientos.

### 8. Implementar servicios de negocio

Implemente los servicios de negocio para cada uno de sus repositorios de acuerdo con los requerimientos del proyecto final. Por ahora puede implementar los m√©todos CRUD b√°sicos (Crear, Leer, Actualizar, Eliminar), pero en las pr√≥ximas gu√≠as se implementar√°n m√©todos m√°s espec√≠ficos.

### 9. Crear controladores REST faltantes

Cree los controladores REST para aquellos servicios de negocio que a√∫n no lo tengan.

### 10. Guardar cambios en Git

Recuerde hacer commit en su repositorio de Git con todo lo realizado en esta gu√≠a.

---

## Para la pr√≥xima clase

- De ahora en adelante, se trabajar√° con el modelo de clases del proyecto final. Crear las clases que se mapear√°n como documentos en la base de datos, incluyendo sus respectivas propiedades e implementar los repositorios correspondientes.

- **Investigar** sobre la inferencia de queries en Spring Boot JPA, a qu√© se refiere y para qu√© sirve.

---

## Referencias Bibliogr√°ficas

1. MongoDB Inc. "Introduction to MongoDB." [https://www.mongodb.com](https://www.mongodb.com)
2. ECMA International. "The JSON Data Interchange Format." [https://www.json.org](https://www.json.org)
3. Oracle. "The Java Tutorials." [https://docs.oracle.com/javase/tutorial/](https://docs.oracle.com/javase/tutorial/)
4. Spring Team. "Spring Data MongoDB." [https://spring.io/projects/spring-data-mongodb](https://spring.io/projects/spring-data-mongodb)
5. Fowler, Martin. "Patterns of Enterprise Application Architecture." Addison-Wesley, 2002.
6. Spring Team. "Repositories in Spring Data." [https://docs.spring.io/spring-data/mongodb/reference/repositories.html](https://docs.spring.io/spring-data/mongodb/reference/repositories.html)
7. Baeldung. "Introduction to Spring Data MongoDB." [https://www.baeldung.com/spring-data-mongodb](https://www.baeldung.com/spring-data-mongodb)
8. Spring Team. "Query Methods in Spring Data." [https://docs.spring.io/spring-data/mongodb/reference/repositories/query-methods-details.html](https://docs.spring.io/spring-data/mongodb/reference/repositories/query-methods-details.html)
9.  Baeldung. "Spring Data MongoDB Queries." [https://www.baeldung.com/queries-in-spring-data-mongodb](https://www.baeldung.com/queries-in-spring-data-mongodb)
10. Spring Team. "MongoDB-specific Query Methods."[https://docs.spring.io/spring-data/mongodb/reference/mongodb/repositories/query-methods.html](https://docs.spring.io/spring-data/mongodb/reference/mongodb/repositories/query-methods.html)