```
Programa de Ingenier√≠a de Sistemas y Computaci√≥n
Universidad del Quind√≠o

T√≠tulo: Dise√±o de APIs REST
Duraci√≥n estimada: 120
Docentes: Carlos Andr√©s Florez, Christian Andr√©s Candela
Gu√≠a: 04
```

# Dise√±o de APIs REST

## üéØ Objetivo

El objetivo de esta gu√≠a es proporcionar una comprensi√≥n clara y detallada sobre c√≥mo dise√±ar y documentar APIs utilizando **OpenAPI**, y c√≥mo integrar estas especificaciones en un proyecto Spring Boot. Adem√°s, se busca que los estudiantes adquieran habilidades pr√°cticas para dise√±ar operaciones CRUD (Crear, Leer, Actualizar, Eliminar) y mecanismos de paginaci√≥n, utilizando OpenAPI como herramienta de documentaci√≥n y generaci√≥n de c√≥digo. 

---

## Conceptos B√°sicos

Antes de profundizar en la configuraci√≥n de un proyecto OpenAPI, es importante entender algunos conceptos fundamentales:

1. **OpenAPI:**  
   Es una especificaci√≥n est√°ndar para describir APIs REST. Permite definir endpoints, m√©todos, par√°metros, respuestas y m√°s, facilitando la documentaci√≥n y el consumo de APIs.

2. **YAML y JSON:**  
   OpenAPI permite definir las especificaciones en formato YAML o JSON. Ambos formatos son ampliamente utilizados y f√°ciles de leer.

3. **Swagger:**  
   Herramienta que permite visualizar y probar APIs documentadas con OpenAPI. Tambi√©n puede generar c√≥digo autom√°ticamente.

4. **Spring Boot:**  
   Framework que simplifica el desarrollo de aplicaciones web en Java. Proporciona utilidades y librer√≠as preconfiguradas que facilitan la creaci√≥n de APIs REST.

---

## Contextualizaci√≥n Te√≥rica

Una **API REST** (Representational State Transfer) es una interfaz que sigue las reglas de la arquitectura REST, permitiendo que diferentes sistemas se comuniquen de forma estandarizada.

En t√©rminos simples, una API define **c√≥mo** deben interactuar distintas aplicaciones o servicios sin exponer su c√≥digo fuente. Esto facilita el desarrollo, ya que el frontend (web, m√≥vil, escritorio, etc.) puede comunicarse con el backend de forma estructurada y segura.

En nuestro caso, el backend est√° construido en **Java con Spring Boot** y la informaci√≥n se transfiere mediante el **protocolo HTTP**, generalmente usando el formato **JSON** por su simplicidad, legibilidad e independencia del lenguaje de programaci√≥n (aunque tambi√©n se pueden usar HTML, XML o texto plano). 

HTTP define m√©todos que indican al servidor qu√© acci√≥n realizar. Estas acciones se aplican **sobre rutas (endpoints)**, que son las direcciones o URLs que representan los recursos de la API. Cada recurso se identifica mediante una ruta √∫nica, y los m√©todos indican el **tipo de operaci√≥n** que se desea realizar sobre ese recurso, ejemplo:

- **GET** `/users` ‚Üí Obtener la lista de usuarios.
- **GET** `/users/1` ‚Üí Obtener el usuario con ID 1.
- **POST** `/users` ‚Üí Crear un nuevo usuario.
- **PUT** `/users/1` ‚Üí Actualizar todos los datos del usuario con ID 1.
- **PATCH** `/users/1` ‚Üí Actualizar parcialmente los datos de ese usuario.
- **DELETE** `/users/1` ‚Üí Eliminar el usuario con ID 1.

Las respuestas del servidor incluyen c√≥digos HTTP para indicar el resultado, esto es √∫til para que el cliente sepa si la solicitud fue exitosa o si hubo alg√∫n error. Algunos c√≥digos comunes son:

- **200 OK** ‚Üí √âxito.
- **201 Created** ‚Üí Recurso creado.
- **400 Bad Request** ‚Üí Solicitud inv√°lida.
- **401 Unauthorized** ‚Üí Requiere autenticaci√≥n.
- **404 Not Found** ‚Üí Recurso no encontrado.
- **500 Internal Server Error** ‚Üí Error interno del servidor.

Cabe destacar que el uso adecuado de los m√©todos HTTP y los c√≥digos de estado es fundamental para el dise√±o de APIs REST efectivas y f√°ciles de usar. 

Siguiendo las buenas pr√°cticas de **OpenAPI**, es importante **documentar** de forma clara los c√≥digos de respuesta de la API. Esto ayuda a que los desarrolladores entiendan r√°pidamente c√≥mo manejar cada respuesta y sus posibles errores.

Tambi√©n es esencial implementar una gesti√≥n de errores adecuada, con mensajes descriptivos y consistentes que faciliten la depuraci√≥n y contribuyan a mejorar continuamente la API.

**Referencia:**  
- Lista completa de m√©todos HTTP: [M√©todos HTTP](https://developer.mozilla.org/es/docs/Web/HTTP/Methods)
- Explicaci√≥n m√°s amplia sobre REST: [¬øQu√© es una API REST?](https://www.redhat.com/es/topics/api/what-is-a-rest-api)


### Herramientas de Documentaci√≥n y Generaci√≥n de C√≥digo

Una herramienta de documentaci√≥n de APIs como OpenAPI permite definir de manera estructurada c√≥mo funciona una API, incluyendo sus endpoints, m√©todos, par√°metros, respuestas y esquemas de datos. Esto facilita la colaboraci√≥n entre equipos y la generaci√≥n autom√°tica de c√≥digo.

#### OpenAPI
OpenAPI es una especificaci√≥n que permite describir APIs REST de manera estandarizada. Utiliza un archivo en formato YAML o JSON para definir la estructura de la API.

- **Archivo `openapi.yaml` o `openapi.json`:** Define la estructura de la API, incluyendo endpoints, m√©todos, par√°metros, respuestas y esquemas de datos.
- **Swagger UI:** Herramienta que permite visualizar y probar la API documentada con OpenAPI.

#### Spring Boot
Spring Boot es un framework que simplifica el desarrollo de aplicaciones web en Java. Proporciona utilidades y librer√≠as preconfiguradas que facilitan la creaci√≥n de APIs REST.

**Referencia:**  
- OpenAPI Documentation: [OpenAPI Specification](https://swagger.io/specification/).  
- Spring Boot Documentation: [Spring Boot Reference](https://docs.spring.io/spring-boot/docs/current/reference/html/).

### Herramientas Clave

1. **JDK (Java Development Kit):**  
   Conjunto de programas y librer√≠as necesarias para el desarrollo de aplicaciones Java. Para este curso, se recomienda el uso de **Java JDK 21**, que es compatible con las √∫ltimas versiones de Spring Boot.  

2. **IntelliJ IDEA Ultimate:**  
   IDE moderno que soporta m√∫ltiples lenguajes de programaci√≥n y ofrece herramientas avanzadas para el desarrollo de aplicaciones web, incluyendo integraci√≥n con **Git**, **Java**, y **Spring Boot**. 

3. **GIT:**  
   Sistema de control de versiones distribuido que permite gestionar cambios en el c√≥digo fuente de manera eficiente.  

---

## Precauciones y Recomendaciones

1. **Verificaci√≥n del JDK:**  
   Aseg√∫rese de tener instalado el JDK 21, ya que es compatible con las √∫ltimas versiones de Spring Boot.

2. **Actualizaci√≥n de Dependencias:**  
   Siempre actualice las dependencias despu√©s de modificar el archivo `build.gradle` para que las configuraciones se apliquen correctamente.

---

## Procedimiento

### 1. Use su proyecto creado en la guia anterior
Abra IntelliJ IDEA y cargue el proyecto creado en la gu√≠a 3.

### 2. Configuraci√≥n del Archivo `build.gradle`
Modifique el archivo `build.gradle` para incluir una nueva dependencia dentro de la secci√≥n `dependencies`:

```groovy
implementation 'org.springdoc:springdoc-openapi-starter-webmvc-ui:2.8.7'
```

> **‚ö†Ô∏è Nota:** No olvide sincronizar Gradle despu√©s de realizar cambios en el archivo `build.gradle`.

### 3. Creaci√≥n del Archivo OpenAPI
Cree un archivo `openapi.yaml` en la carpeta `src/main/resources` con el siguiente contenido:

```yaml
openapi: 3.0.0
info:
  title: API de Usuarios
  version: 1.0.0
paths:
  /users:
    post:
      summary: Registrar un nuevo usuario
      operationId: registerUser
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserRegistration'
      responses:
        '201':
          description: Usuario registrado exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '400':
          description: Datos de entrada inv√°lidos
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Correo ya registrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Error interno del servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: Servicio no disponible
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /users/{id}/password:
    patch:
      summary: Actualizar la contrase√±a de un usuario
      operationId: updatePasswordByUserId
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PasswordUpdate'
      responses:
        '200':
          description: Contrase√±a actualizada exitosamente
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SuccessResponse'
        '400':
          description: Datos de entrada inv√°lidos
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: No autorizado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '403':
          description: Prohibido (sin permisos suficientes)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Usuario no encontrado
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Error interno del servidor
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '503':
          description: Servicio no disponible
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
components:
  schemas:
    UserRegistration:
      type: object
      properties:
        email:
          type: string
          format: email
        password:
          type: string
          minLength: 8
          pattern: "^(?=.*\\d)(?=.*[a-z])(?=.*[A-Z]).*$"
          description: La contrase√±a del usuario (debe contener al menos un d√≠gito, una letra min√∫scula y una letra may√∫scula)
        fullName:
          type: string
          maxLength: 100
        dateBirth:
          type: string
          format: date
          example: "1990-01-01"
        role:
          type: string
          enum:
            - user
            - admin
          default: user
      required:
        - fullName
        - email
        - password
    PasswordUpdate:
      type: object
      required:
        - currentPassword
        - newPassword
      properties:
        currentPassword:
          type: string
          description: Contrase√±a actual del usuario
        newPassword:
          type: string
          minLength: 8
          pattern: "^(?=.*\\d)(?=.*[a-z])(?=.*[A-Z]).*$"
          description: Nueva contrase√±a del usuario (debe contener al menos un d√≠gito, una letra min√∫scula y una letra may√∫scula)
    SuccessResponse:
      type: object
      properties:
        message:
          type: string
          example: "Contrase√±a actualizada exitosamente"
      required:
        - message
    UserResponse:
      type: object
      properties:
        id:
          type: string
        email:
          type: string
        fullName:
          type: string
        dateBirth:
          type: string
          format: date
        role:
          type: string
      required:
        - id
        - email
        - fullName
        - role
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
        message:
          type: string
      required:
        - error
        - message
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
```

### 4. Visualizaci√≥n del Archivo OpenAPI en IntelliJ IDEA
- Abra el archivo `openapi.yaml` en IntelliJ IDEA.
- IntelliJ IDEA tiene soporte integrado para visualizar archivos OpenAPI. Puede usar la vista previa para ver la estructura de la API.

### 5. Analice el Archivo OpenAPI
- Observe las rutas definidas en la secci√≥n `paths` del archivo `openapi.yaml`, recuerde no incluir verbos directamente en la ruta ya que el **m√©todo HTTP** ya lo indica.
- Revise los esquemas de datos definidos en la secci√≥n `components/schemas` del archivo `openapi.yaml`.
- Aseg√∫rese de que todos los modelos de datos necesarios est√©n correctamente definidos y que incluyan las propiedades requeridas.
- Verifique que los tipos de datos y las restricciones (como `minLength`, `maxLength`, `pattern`, etc.) sean apropiados y est√©n bien documentados.

### 6. Investigar c√≥digos de estado HTTP y aspectos de seguridad 

- Investigue los c√≥digos de estado HTTP m√°s comunes y su significado (por ejemplo, `200 OK`, `404 Not Found`, `500 Internal Server Error`, etc.).
- Considere c√≥mo manejar los errores en su API y qu√© informaci√≥n incluir en las respuestas de error.
- Investigue sobre la seguridad en las APIs REST, incluyendo la autenticaci√≥n y autorizaci√≥n (por ejemplo, usando JWT).

---

## Reto pr√°ctica

### Dise√±o de Operaciones CRUD y Paginaci√≥n

Dise√±e las siguientes operaciones utilizando OpenAPI:

1. **Borrar Usuario:**
   - M√©todo: `DELETE`
   - Ruta: `/users/{id}`
   - Respuestas: `200`, `401`, `403`, `404`, `500`, `503`

2. **Consultar un Usuario:**
   - M√©todo: `GET`
   - Ruta: `/users/{id}`
   - Respuestas: `200`, `401`, `403`, `404`, `500`, `503`

3. **Actualizar un Usuario:**
   - M√©todo: `PUT`
   - Ruta: `/users/{id}`
   - Respuestas: `200`, `400`, `401`, `403`, `404`, `409`, `500`, `503`

4. **Consultar M√∫ltiples Usuarios (Paginaci√≥n):**
   - M√©todo: `GET`
   - Ruta: `/users`
   - Par√°metros: `page`, `size`
   - Respuestas: `200`, `401`, `403`, `500`, `503`

### Requisitos de la Actividad
- Los estudiantes deben definir las operaciones en el archivo `openapi.yaml`.
- Deben incluir esquemas de datos, respuestas y c√≥digos de estado.

---

## Evaluaci√≥n o Resultado

Se espera que los estudiantes completen la configuraci√≥n de un proyecto b√°sico utilizando OpenAPI y Spring Boot. Al finalizar, deben ser capaces de:

1. Crear un archivo OpenAPI que defina las operaciones CRUD y paginaci√≥n.
2. Investigar c√≥mo generar el c√≥digo base en Spring Boot utilizando Swagger Codegen a partir del archivo OpenAPI.

---

## Pr√≥xima Actividad

Para prepararse para las pr√≥ximas clases, los estudiantes deben investigar sobre:

1. **Servicios REST en Spring** (`@PostMapping`, `@PatchMapping`, etc)
2. **Bean Validation**
3. **Controladores REST** (`@RestController`)

---

## Referencias Bibliogr√°ficas

1. OpenAPI Documentation: [OpenAPI Specification](https://swagger.io/specification/).
2. Spring Boot Documentation: [Spring Boot Reference](https://docs.spring.io/spring-boot/docs/current/reference/html/).
3. OpenAPI Generator: [OpenAPI Generator](https://openapi-generator.tech).
4. IntelliJ IDEA Documentation: [JetBrains Docs](https://www.jetbrains.com/idea/documentation/).